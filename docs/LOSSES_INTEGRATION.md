# üóëÔ∏è Loss History Integration - Frontend + Backend

## ‚ö†Ô∏è Status: **PENDING BACKEND AUTH FIX**

**Frontend**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω  
**Backend**: ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è auth middleware

### üîß –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

**–ü—Ä–æ–±–ª–µ–º–∞**: `/api/history/losses` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ `Authorization: Bearer`, –∏–≥–Ω–æ—Ä–∏—Ä—É—è cookie-based auth.

**–†–µ—à–µ–Ω–∏–µ**: –°–º. [`QUICK_AUTH_FIX.md`](./QUICK_AUTH_FIX.md) (5 –º–∏–Ω—É—Ç)

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è backend –≤—Å—è —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1Ô∏è‚É£ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –û—á–∏—Å—Ç–∫–∞ (Backend)**

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ (`GET /api/fridge/items`), –±—ç–∫–µ–Ω–¥:

1. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç** –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –≥–æ–¥–Ω–æ—Å—Ç–∏
2. **–ù–∞—Ö–æ–¥–∏—Ç** –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ (`expires_at < NOW()`)
3. **–°–æ–∑–¥–∞–µ—Ç** —Å–æ–±—ã—Ç–∏—è –≤ `history_events` —Å —Ç–∏–ø–æ–º `expired`
4. **–£–¥–∞–ª—è–µ—Ç** –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞
5. **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç** —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã

```go
// Backend: internal/storage/postgres/fridge.go
func (s *Storage) cleanupExpiredItems(ctx context.Context, userID uuid.UUID) error {
    // Find expired items
    query := `SELECT id, name, quantity, unit, price_per_unit FROM fridge_items 
              WHERE user_id = $1 AND expires_at < NOW()`
    
    // Create history events
    // DELETE expired items
}
```

### 2Ô∏è‚É£ **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ü–æ—Ç–µ—Ä—å (Frontend)**

–§—Ä–æ–Ω—Ç–µ–Ω–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. **–ó–∞–≥—Ä—É–∂–∞–µ—Ç** –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Ç–µ—Ä—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã `/fridge`
2. **–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç** –±–ª–æ–∫ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Ç–µ—Ä–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
3. **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç** —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ—Ä—á–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   - –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ç–µ—Ä—å (PLN)
   - –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏

```tsx
// Frontend: app/fridge/page.tsx
{!lossesLoading && lossSummary.totalLoss > 0 && (
  <motion.div className="...orange-gradient...">
    <h3>‚ö†Ô∏è –ü–æ—Ç–µ—Ä–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</h3>
    <p>{lossSummary.products} –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Ä¢ {lossSummary.totalLoss.toFixed(2)} PLN –ø–æ—Ç–µ—Ä—å</p>
    <button onClick={() => router.push('/losses')}>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
  </motion.div>
)}
```

---

## üì° API Contract

### **GET /api/history/losses?days=30**

**Request:**
```http
GET /api/history/losses?days=30 HTTP/1.1
Authorization: Bearer <token>
```

**Response:**
```json
{
  "events": [
    {
      "id": "uuid-here",
      "name": "–ú–æ–ª–æ–∫–æ",
      "quantity": 1.0,
      "unit": "–ª",
      "loss": 4.50,
      "reason": "expired",
      "addedDate": "2025-12-01T10:00:00Z",
      "expiryDate": "2025-12-15T10:00:00Z",
      "daysInFridge": 7
    }
  ],
  "summary": {
    "totalProducts": 5,
    "totalValue": 45.50,
    "avgValue": 9.10,
    "currency": "PLN"
  }
}
```

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Frontend `.env.local`
```bash
# API Backend URL
NEXT_PUBLIC_API_BASE=https://yeasty-madelaine-fodi999-671ccdf5.koyeb.app
```

### Frontend Hook
```typescript
// hooks/useFridgeLosses.ts
const apiUrl = process.env.NEXT_PUBLIC_API_BASE;
const response = await fetch(`${apiUrl}/api/history/losses?days=${days}`, {
  method: "GET",
  headers: {
    Authorization: `Bearer ${token}`,
    "Content-Type": "application/json",
  },
});
```

---

## üé® UI Components

### –ë–ª–æ–∫ –ü–æ—Ç–µ—Ä—å –Ω–∞ `/fridge`
- **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:** –ï—Å–ª–∏ `lossSummary.totalLoss > 0`
- **–¶–≤–µ—Ç:** –û—Ä–∞–Ω–∂–µ–≤–æ-–∫—Ä–∞—Å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç (warning, –Ω–µ guilt)
- **–°–æ–¥–µ—Ä–∂–∏—Ç:**
  - –ò–∫–æ–Ω–∫–∞ AlertCircle
  - –ó–∞–≥–æ–ª–æ–≤–æ–∫: "‚ö†Ô∏è –ü–æ—Ç–µ—Ä–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π"
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: "5 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Ä¢ 45.50 PLN –ø–æ—Ç–µ—Ä—å"
  - –ö–Ω–æ–ø–∫–∞: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é" ‚Üí `/losses`

### Graceful Fallback
- ‚úÖ –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –±–ª–æ–∫ –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏ (silent fallback)
- ‚úÖ –ù–µ –ª–æ–º–∞–µ—Ç UI —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Å—Ä–æ–∫–æ–º –≥–æ–¥–Ω–æ—Å—Ç–∏
```bash
# 1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ —Å expires_at —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É
POST /api/fridge/items
{
  "productId": "uuid",
  "quantity": 1,
  "unit": "–ª"
}

# 2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 1 –º–∏–Ω—É—Ç—É

# 3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞
GET /api/fridge/items
# ‚Üí –ü—Ä–æ–¥—É–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ç–µ—Ä–∏
GET /api/history/losses?days=30
# ‚Üí –ü—Ä–æ–¥—É–∫—Ç –≤ —Å–ø–∏—Å–∫–µ —Å–æ–±—ã—Ç–∏–π —Å type="expired"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å UI –±–ª–æ–∫–∞ –ø–æ—Ç–µ—Ä—å
1. –û—Ç–∫—Ä—ã—Ç—å `/fridge`
2. –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Ç–µ—Ä–∏ ‚Üí —É–≤–∏–¥–µ—Ç—å –æ—Ä–∞–Ω–∂–µ–≤—ã–π –±–ª–æ–∫
3. –ù–∞–∂–∞—Ç—å "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
4. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ `/losses` (TODO: —Å–æ–∑–¥–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É)

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

–ë–ª–æ–∫ –ø–æ—Ç–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ |
|---------|----------|----------|
| **products** | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ—Ä—á–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ | `summary.totalProducts` |
| **totalLoss** | –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ç–µ—Ä—å (PLN) | `summary.totalValue` |
| **avgLoss** | –°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç | `summary.avgValue` |

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### TODO: –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É `/losses`
- [ ] –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –ø–æ—Ç–µ—Ä—å
- [ ] –§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–∞–º, –ø—Ä–∏—á–∏–Ω–∞–º
- [ ] –ì—Ä–∞—Ñ–∏–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV

### TODO: –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É
- [ ] –¢–æ–ø-3 —Å–∞–º—ã—Ö —á–∞—Å—Ç–æ –ø–æ—Ä—Ç—è—â–∏—Ö—Å—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- [ ] –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ AI –ø–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—é –ø–æ—Ç–µ—Ä—å
- [ ] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª—ã–º –º–µ—Å—è—Ü–µ–º

### TODO: Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞
- [ ] –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –ø–æ—Ç–µ—Ä—è—Ö

---

## ‚úÖ Checklist Ready

- ‚úÖ Backend: Auto cleanup on `GET /api/fridge/items`
- ‚úÖ Backend: API endpoint `/api/history/losses`
- ‚úÖ Frontend: Hook `useFridgeLosses`
- ‚úÖ Frontend: UI block on `/fridge` page
- ‚úÖ Environment: `NEXT_PUBLIC_API_BASE` configured
- ‚úÖ Error handling: Graceful fallback
- ‚úÖ Documentation: Integration guide

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ**
