# Auth 2026 - Fix Invalid Token

**–î–∞—Ç–∞**: 2026-01-26  
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ localStorage (length: 9, –Ω–µ JWT)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

## –ü—Ä–æ–±–ª–µ–º–∞

### –°–∏–º–ø—Ç–æ–º—ã
- `Token extracted, length: 9` - —Ç–æ–∫–µ–Ω –∏–º–µ–µ—Ç –¥–ª–∏–Ω—É –≤—Å–µ–≥–æ 9 —Å–∏–º–≤–æ–ª–æ–≤
- `token is malformed: token contains an invalid number of segments` - —Ç–æ–∫–µ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JWT
- `401 Unauthorized` –Ω–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º

### –ü—Ä–∏—á–∏–Ω–∞
1. **–í localStorage —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å—Ç–∞—Ä—ã–π –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω**
   - –í–æ–∑–º–æ–∂–Ω–æ "undefined" –∏–ª–∏ –∫–∞–∫–æ–µ-—Ç–æ –∫–æ—Ä–æ—Ç–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
   - –¢–æ–∫–µ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JWT (–Ω–µ –∏–º–µ–µ—Ç 3 —á–∞—Å—Ç–µ–π —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–æ—á–∫–∞–º–∏)

2. **authFetch –Ω–µ –æ—á–∏—â–∞–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã**
   - –ü—Ä–æ–≤–µ—Ä—è–ª —Ç–æ–∫–µ–Ω, –Ω–æ –Ω–µ –æ—á–∏—â–∞–ª –µ—Å–ª–∏ –æ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
   - –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω –æ—Å—Ç–∞–≤–∞–ª—Å—è –≤ localStorage

3. **Proxy –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞**
   - –ü—Ä–∏–Ω–∏–º–∞–ª –ª—é–±–æ–π —Ç–æ–∫–µ–Ω –∏–∑ cookies/header
   - –ü–µ—Ä–µ–¥–∞–≤–∞–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ backend

---

## –†–µ—à–µ–Ω–∏–µ

### ‚úÖ –®–ê–ì 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω authFetch

**–§–∞–π–ª**: `lib/api/authFetch.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
1. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –∏–∑ localStorage
2. ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç –¥–ª–∏–Ω—É —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
3. ‚úÖ –ù–µ –¥–æ–±–∞–≤–ª—è–µ—Ç Authorization header –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

**–ö–æ–¥**:
```typescript
if (token && isValidJWT(token)) {
  headers.set("Authorization", `Bearer ${token}`);
  console.log("[authFetch] ‚úÖ Valid JWT token found, adding Authorization header");
} else {
  if (token) {
    console.warn(`[authFetch] ‚ö†Ô∏è Token is not a valid JWT (length: ${token.length}), skipping Authorization header`);
    // –û—á–∏—â–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
    localStorage.removeItem("access_token");
    localStorage.removeItem("token"); // Legacy
    console.log("[authFetch] üßπ Cleared invalid token from localStorage");
  }
}
```

### ‚úÖ –®–ê–ì 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Proxy

**–§–∞–π–ª**: `lib/api/proxy.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ `isValidJWT()`
2. ‚úÖ –û—Ç–∫–ª–æ–Ω—è–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ cookies/header
3. ‚úÖ –î–ª—è `skipAuth: true` - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)

**–ö–æ–¥**:
```typescript
const isValidJWT = (t: string | undefined): boolean => {
  if (!t || typeof t !== "string") {
    return false;
  }
  const parts = t.split(".");
  return parts.length === 3;
};

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
if (token && !isValidJWT(token)) {
  console.warn(`[Proxy] ‚ö†Ô∏è Invalid token format (length: ${token.length}), rejecting`);
  token = undefined;
}
```

### ‚úÖ –®–ê–ì 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω AuthContext

**–§–∞–π–ª**: `contexts/AuthContext.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
3. ‚úÖ –ù–µ –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º

**–ö–æ–¥**:
```typescript
const isValidJWT = (token: string | null): boolean => {
  if (!token || typeof token !== "string") {
    return false;
  }
  const parts = token.split(".");
  return parts.length === 3;
};

const loadMe = async () => {
  const accessToken = localStorage.getItem("access_token");
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π JWT
  if (!isValidJWT(accessToken)) {
    console.warn(`[AuthContext] ‚ö†Ô∏è Invalid token format (length: ${accessToken?.length}), clearing`);
    localStorage.removeItem("access_token");
    // ...
    setUser(null);
    return;
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π
  const res = await AuthAPI.me();
  // ...
};
```

### ‚úÖ –®–ê–ì 4: –£–±—Ä–∞–Ω —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –∏–∑ CategoryContext

**–§–∞–π–ª**: `contexts/CategoryContext.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- ‚ùå –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `fetchCategories()` –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `authFetch`

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞

### –ü—Ä–∞–≤–∏–ª–∞

1. **–¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π**
2. **–¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å 3 —á–∞—Å—Ç–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∞–º–∏** (JWT —Ñ–æ—Ä–º–∞—Ç)
3. **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞**: ~100 —Å–∏–º–≤–æ–ª–æ–≤ (–æ–±—ã—á–Ω–æ JWT —Ç–æ–∫–µ–Ω—ã –¥–ª–∏–Ω–Ω–µ–µ)

### –ü—Ä–∏–º–µ—Ä—ã

‚úÖ –í–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω:
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```
Length: ~260 —Å–∏–º–≤–æ–ª–æ–≤, 3 —á–∞—Å—Ç–∏

‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω:
```
undefined
```
Length: 9 —Å–∏–º–≤–æ–ª–æ–≤, –Ω–µ JWT —Ñ–æ—Ä–º–∞—Ç

---

## –û—á–∏—Å—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞

1. **authFetch** - –æ—á–∏—â–∞–µ—Ç –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
2. **AuthContext** - –æ—á–∏—â–∞–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. **Proxy** - –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç –≤ backend)

### –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:
```javascript
localStorage.clear();
location.reload();
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

1. –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω –æ–±–Ω–∞—Ä—É–∂–µ–Ω
   - authFetch –æ—á–∏—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ localStorage
   - Authorization header –ù–ï –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è
   - –ó–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

2. –í–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
   - authFetch –¥–æ–±–∞–≤–ª—è–µ—Ç Authorization header
   - Proxy –ø–µ—Ä–µ–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω –≤ backend
   - Backend –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ

### ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (—Å—Ç–∞—Ä–æ–µ)

1. –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –≤ backend
2. Backend –≤–æ–∑–≤—Ä–∞—â–∞–ª 401
3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞—é—Ç—Å—è
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
3. ‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º backend
4. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
